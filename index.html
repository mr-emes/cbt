<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT OMI - Computer Based Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }
        }
        
        .cbt-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .cbt-header {
                padding: 0.75rem 1rem;
                height: auto;
                min-height: 70px;
            }
        }
        
        .question-nav {
            background: #ffffff;
            border-right: 2px solid #e5e7eb;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }
        
        .question-content {
            background: #ffffff;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }
        
        .question-controls {
            background: #f9fafb;
            border-left: 2px solid #e5e7eb;
            height: calc(100vh - 80px);
        }
        
        @media (max-width: 768px) {
            .question-nav {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
                border-bottom: 2px solid #e5e7eb;
            }
            
            .question-nav.show {
                transform: translateX(0);
            }
            
            .question-content {
                height: auto;
                min-height: calc(100vh - 70px);
                padding-bottom: 80px;
            }
            
            .question-controls {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 80px;
                border-left: none;
                border-top: 2px solid #e5e7eb;
                z-index: 40;
                padding: 0.75rem;
            }
        }
        
        .question-number {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
        }
        
        .question-number.unanswered {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #d1d5db;
        }
        
        .question-number.answered {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #22c55e;
        }
        
        .question-number.doubt {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }
        
        .question-number.current {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .option-button {
            transition: all 0.2s ease;
            border: 2px solid #e5e7eb;
        }
        
        .option-button:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .option-button.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .timer-warning {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .mobile-nav-toggle {
            display: none;
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 45;
        }
        
        @media (max-width: 768px) {
            .mobile-nav-toggle {
                display: block;
            }
            
            .mobile-overlay.show {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Smart Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-600 to-green-800">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-2 border-green-200">
                    <img src="https://archive.org/download/logo-min-singkawang/logo%20min%20singkawang.jpg" 
                         alt="Logo MIN Singkawang" 
                         class="w-16 h-16 rounded-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-sm" style="display: none;">MIN</div>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">CBT MIN SINGKAWANG</h1>
                <p class="text-gray-600">Madrasah Ibtidaiyah Negeri Singkawang</p>
                <p class="text-sm text-gray-500 mt-2">Computer Based Test System</p>
            </div>
            
            <form onsubmit="handleSmartLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username / NISN</label>
                        <input type="text" id="username" placeholder="Masukkan Username atau NISN" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" placeholder="Masukkan Password" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        üöÄ Masuk Sistem
                    </button>
                </div>
            </form>
            
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Student Demo -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-3">üë®‚Äçüéì Demo Siswa:</h4>
                    <div class="space-y-2">
                        <div class="bg-white p-3 rounded border-l-4 border-green-500">
                            <p class="text-xs font-medium text-gray-800">NISN: <span class="font-mono bg-gray-100 px-1 py-0.5 rounded text-xs">1234567890</span></p>
                            <p class="text-xs font-medium text-gray-800">Pass: <span class="font-mono bg-gray-100 px-1 py-0.5 rounded text-xs">min2025</span></p>
                        </div>
                    </div>
                    <button type="button" onclick="autoFillStudent()" class="mt-3 w-full bg-green-100 hover:bg-green-200 text-green-800 py-2 px-4 rounded-lg text-xs font-medium transition-colors">
                        üöÄ Auto Fill Siswa
                    </button>
                </div>
                
                <!-- Admin Demo -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-3">üîß Demo Admin:</h4>
                    <div class="space-y-2">
                        <div class="bg-white p-3 rounded border-l-4 border-blue-500">
                            <p class="text-xs font-medium text-gray-800">User: <span class="font-mono bg-gray-100 px-1 py-0.5 rounded text-xs">admin</span></p>
                            <p class="text-xs font-medium text-gray-800">Pass: <span class="font-mono bg-gray-100 px-1 py-0.5 rounded text-xs">admin123</span></p>
                        </div>
                    </div>
                    <button type="button" onclick="autoFillAdmin()" class="mt-3 w-full bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-4 rounded-lg text-xs font-medium transition-colors">
                        üöÄ Auto Fill Admin
                    </button>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                <h4 class="font-semibold text-gray-800 mb-2">ü§ñ Smart Login:</h4>
                <div class="text-xs text-gray-600 space-y-1">
                    <p>‚ú® Sistem otomatis mendeteksi jenis pengguna</p>
                    <p>üë®‚Äçüéì NISN ‚Üí Masuk sebagai Siswa</p>
                    <p>üîß Username ‚Üí Masuk sebagai Admin</p>
                    <p>üîÄ Soal diacak otomatis untuk setiap siswa</p>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h4 class="font-semibold text-yellow-800 mb-2">üé≤ Fitur CBT:</h4>
                <div class="text-xs text-yellow-700 space-y-1">
                    <p>üñºÔ∏è Soal dengan gambar/diagram interaktif</p>
                    <p>üì± Responsive untuk semua perangkat</p>
                    <p>‚è±Ô∏è Timer countdown dengan peringatan</p>
                    <p>üìä Laporan hasil ujian real-time</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CBT Interface -->
    <div id="cbtInterface" class="hidden">
        <!-- Header -->
        <div class="cbt-header h-20 flex items-center justify-between px-6 text-white">
            <div class="flex items-center space-x-3 md:space-x-4">
                <div class="bg-white bg-opacity-20 p-1 rounded-lg">
                    <img src="https://archive.org/download/logo-min-singkawang/logo%20min%20singkawang.jpg" 
                         alt="Logo MIN Singkawang" 
                         class="w-8 h-8 md:w-10 md:h-10 rounded-lg object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-green-800 rounded-lg flex items-center justify-center text-white font-bold text-xs" style="display: none;">MIN</div>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold">CBT MIN SINGKAWANG</h1>
                    <p class="text-xs md:text-sm opacity-90">Matematika - Tingkat MI</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-6">
                <div class="text-right hidden md:block">
                    <p class="text-sm opacity-90">Peserta:</p>
                    <p class="font-semibold" id="participantName">Ahmad Rizki</p>
                </div>
                <div class="bg-white bg-opacity-20 px-2 py-1 md:px-4 md:py-2 rounded-lg">
                    <p class="text-xs md:text-sm opacity-90">Sisa Waktu:</p>
                    <p class="text-lg md:text-xl font-bold" id="timer">01:30:00</p>
                </div>
            </div>
        </div>
        
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeMobileNav()"></div>

        <div class="flex md:flex-row flex-col">
            <!-- Question Navigation -->
            <div class="question-nav w-64 md:w-64 p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-gray-800">Navigasi Soal</h3>
                    <button class="md:hidden bg-gray-200 p-2 rounded-lg" onclick="closeMobileNav()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-5 md:grid-cols-4 gap-1" id="questionNavigation">
                    <!-- Question numbers will be populated here -->
                </div>
                
                <div class="mt-6 space-y-3">
                    <div class="flex items-center space-x-2">
                        <div class="question-number unanswered">1</div>
                        <span class="text-sm text-gray-600">Belum dijawab</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="question-number answered">2</div>
                        <span class="text-sm text-gray-600">Sudah dijawab</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="question-number doubt">3</div>
                        <span class="text-sm text-gray-600">Ragu-ragu</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="question-number current">4</div>
                        <span class="text-sm text-gray-600">Sedang dikerjakan</span>
                    </div>
                </div>
                
                <!-- Mobile Info Panel -->
                <div class="md:hidden mt-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">Informasi Soal</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Soal ke:</span>
                            <span class="font-semibold" id="mobileCurrentQuestionNumber">1</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total soal:</span>
                            <span class="font-semibold">20</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Terjawab:</span>
                            <span class="font-semibold text-green-600" id="mobileAnsweredCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ragu-ragu:</span>
                            <span class="font-semibold text-yellow-600" id="mobileDoubtCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Content -->
            <div class="question-content flex-1 p-4 md:p-6">
                <div class="fade-in" id="questionContainer">
                    <!-- Question content will be populated here -->
                </div>
            </div>

            <!-- Question Controls - Desktop -->
            <div class="question-controls w-64 p-4 hidden md:block">
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-semibold text-gray-800 mb-2">Informasi Soal</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Soal ke:</span>
                                <span class="font-semibold" id="currentQuestionNumber">1</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total soal:</span>
                                <span class="font-semibold">20</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Terjawab:</span>
                                <span class="font-semibold text-green-600" id="answeredCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ragu-ragu:</span>
                                <span class="font-semibold text-yellow-600" id="doubtCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="markAsDoubt()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                            ü§î Ragu-ragu
                        </button>
                        
                        <div class="flex space-x-2">
                            <button onclick="previousQuestion()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                ‚Üê Sebelum
                            </button>
                            <button onclick="nextQuestion()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                Selanjutnya ‚Üí
                            </button>
                        </div>
                        
                        <button onclick="showSubmitConfirmation()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                            üèÅ Selesai Ujian
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Question Controls - Mobile (Bottom Bar) -->
            <div class="question-controls md:hidden">
                <div class="flex items-center justify-between h-full">
                    <button onclick="toggleMobileNav()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        üìã Navigasi
                    </button>
                    
                    <div class="flex space-x-2">
                        <button onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            ‚Üê
                        </button>
                        <button onclick="markAsDoubt()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            ü§î
                        </button>
                        <button onclick="nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            ‚Üí
                        </button>
                    </div>
                    
                    <button onclick="showSubmitConfirmation()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors">
                        üèÅ Selesai
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submitModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Konfirmasi Selesai</h2>
                <p class="text-gray-600">Apakah Anda yakin ingin mengakhiri ujian?</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-2">Ringkasan Pengerjaan:</h4>
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between">
                        <span>Total soal:</span>
                        <span class="font-semibold">20</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Sudah dijawab:</span>
                        <span class="font-semibold text-green-600" id="modalAnsweredCount">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Belum dijawab:</span>
                        <span class="font-semibold text-red-600" id="modalUnansweredCount">20</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Ragu-ragu:</span>
                        <span class="font-semibold text-yellow-600" id="modalDoubtCount">0</span>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="hideSubmitConfirmation()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                    Batal
                </button>
                <button onclick="submitExam()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                    Ya, Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen bg-gray-100">
        <!-- Admin Header -->
        <div class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img src="https://archive.org/download/logo-min-singkawang/logo%20min%20singkawang.jpg" 
                         alt="Logo MIN Singkawang" 
                         class="w-10 h-10 rounded-lg object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-10 h-10 bg-blue-800 rounded-lg flex items-center justify-center text-white font-bold text-xs" style="display: none;">MIN</div>
                    <div>
                        <h1 class="text-xl font-bold">Admin CBT MIN SINGKAWANG</h1>
                        <p class="text-sm opacity-90">Panel Administrasi</p>
                    </div>
                </div>
                <button onclick="showScreen('loginScreen')" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    üö™ Logout
                </button>
            </div>
        </div>

        <div class="flex">
            <!-- Admin Sidebar -->
            <div class="w-64 bg-white shadow-lg h-screen overflow-y-auto">
                <div class="p-4">
                    <nav class="space-y-2">
                        <button onclick="showAdminSection('dashboard')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-700 font-medium">
                            üìä Dashboard
                        </button>
                        <button onclick="showAdminSection('students')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700">
                            üë• Data Siswa
                        </button>
                        <button onclick="showAdminSection('questions')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700">
                            üìù Data Soal
                        </button>
                        <button onclick="showAdminSection('exams')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700">
                            üìã Data Ujian
                        </button>
                        <button onclick="showAdminSection('results')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700">
                            üèÜ Hasil Ujian
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Admin Content -->
            <div class="flex-1 p-6 overflow-y-auto">
                <!-- Dashboard Section -->
                <div id="adminDashboardSection" class="admin-section">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center">
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <span class="text-2xl">üë•</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalStudents">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center">
                                <div class="bg-green-100 p-3 rounded-full">
                                    <span class="text-2xl">üìù</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Total Soal</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalQuestions">20</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center">
                                <div class="bg-yellow-100 p-3 rounded-full">
                                    <span class="text-2xl">üìã</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Total Ujian</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalExams">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center">
                                <div class="bg-purple-100 p-3 rounded-full">
                                    <span class="text-2xl">üèÜ</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Rata-rata Nilai</p>
                                    <p class="text-2xl font-bold text-gray-800" id="averageScore">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                        <div id="recentActivity" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>
                        </div>
                    </div>
                </div>

                <!-- Students Section -->
                <div id="adminStudentsSection" class="admin-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Data Siswa</h2>
                        <button onclick="showAddStudentModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ûï Tambah Siswa
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTable" class="divide-y divide-gray-200">
                                    <!-- Students data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Questions Section -->
                <div id="adminQuestionsSection" class="admin-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Data Soal</h2>
                        <div class="flex space-x-2">
                            <button onclick="showAddQuestionModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                                ‚ûï Tambah Soal
                            </button>
                            <button onclick="showImportExcelModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                üìä Import Excel
                            </button>
                            <button onclick="downloadExcelTemplate()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                                üì• Template Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Soal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipe</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jawaban Benar</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="questionsTable" class="divide-y divide-gray-200">
                                    <!-- Questions data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Exams Section -->
                <div id="adminExamsSection" class="admin-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Data Ujian</h2>
                        <button onclick="showCreateExamModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ûï Buat Ujian Baru
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Ujian</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mata Pelajaran</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Durasi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="examsTable" class="divide-y divide-gray-200">
                                    <!-- Exams data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="adminResultsSection" class="admin-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Hasil Ujian</h2>
                    
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ujian</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nilai</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable" class="divide-y divide-gray-200">
                                    <!-- Results data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-green-600 to-green-800">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg text-center">
            <div class="bg-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg border-2 border-green-200">
                <img src="https://archive.org/download/logo-min-singkawang/logo%20min%20singkawang.jpg" 
                     alt="Logo MIN Singkawang" 
                     class="w-16 h-16 rounded-full object-cover"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-sm" style="display: none;">MIN</div>
            </div>
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">Ujian Selesai!</h1>
                    <p class="text-gray-600 mb-2">Terimakasih telah mengikuti Ujian <span class="font-semibold text-green-600">Matematika</span></p>
                </div>
                <button onclick="showScreen('loginScreen')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-2 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Display -->
            <div class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl mb-6 border-2 border-green-200">
                <div class="text-center mb-4">
                    <div class="text-4xl font-bold text-green-600 mb-2" id="finalScore">0</div>
                    <div class="text-lg font-semibold text-gray-700">Nilai Akhir</div>
                    <div class="inline-block bg-green-600 text-white px-4 py-2 rounded-full text-xl font-bold mt-2" id="finalGrade">E</div>
                </div>
            </div>
            
            <!-- Detailed Results -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800">üìä Detail Hasil:</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-green-600 font-semibold text-lg" id="finalCorrect">0</div>
                        <div class="text-gray-600">Jawaban Benar</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-red-600 font-semibold text-lg" id="finalIncorrect">0</div>
                        <div class="text-gray-600">Jawaban Salah</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-blue-600 font-semibold text-lg" id="finalAnsweredCount">0</div>
                        <div class="text-gray-600">Total Dijawab</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-purple-600 font-semibold text-lg" id="finalTime">00:00:00</div>
                        <div class="text-gray-600">Waktu Pengerjaan</div>
                    </div>
                </div>
            </div>
            
            <!-- Grade Information -->
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h4 class="font-semibold text-blue-800 mb-2">üìã Kriteria Penilaian:</h4>
                <div class="text-xs text-blue-700 space-y-1">
                    <div class="flex justify-between">
                        <span>A: 90-100</span>
                        <span>B: 80-89</span>
                        <span>C: 70-79</span>
                    </div>
                    <div class="flex justify-between">
                        <span>D: 60-69</span>
                        <span>E: < 60</span>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <p class="text-sm text-gray-500">Selamat! Hasil ujian sudah tersedia</p>
                <button onclick="showScreen('loginScreen')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors">
                    üè† Kembali ke Halaman Login
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Modals -->
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Tambah Siswa Baru</h2>
            <form onsubmit="addStudent(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                        <input type="text" id="newStudentNISN" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="newStudentName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="newStudentClass" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Kelas</option>
                            <option value="1A">1A</option>
                            <option value="1B">1B</option>
                            <option value="2A">2A</option>
                            <option value="2B">2B</option>
                            <option value="3A">3A</option>
                            <option value="3B">3B</option>
                            <option value="4A">4A</option>
                            <option value="4B">4B</option>
                            <option value="5A">5A</option>
                            <option value="5B">5B</option>
                            <option value="6A">6A</option>
                            <option value="6B">6B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="newStudentPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideAddStudentModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        Tambah
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-2xl max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Tambah Soal Baru</h2>
            <form onsubmit="addQuestion(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                        <textarea id="newQuestionText" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                        <select id="newQuestionType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Tipe</option>
                            <option value="multiple_choice">Pilihan Ganda</option>
                            <option value="multiple_choice_with_images">Pilihan Ganda dengan Gambar</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                        <div class="space-y-2">
                            <input type="text" id="newQuestionOptionA" placeholder="Pilihan A" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="newQuestionOptionB" placeholder="Pilihan B" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="newQuestionOptionC" placeholder="Pilihan C" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="newQuestionOptionD" placeholder="Pilihan D" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                        <select id="newQuestionCorrect" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Jawaban Benar</option>
                            <option value="0">A</option>
                            <option value="1">B</option>
                            <option value="2">C</option>
                            <option value="3">D</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideAddQuestionModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        Tambah
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Excel Modal -->
    <div id="importExcelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Import Soal dari Excel</h2>
            
            <div class="mb-6">
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">üìã Format Excel yang Sederhana:</h4>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>Kolom A:</strong> Mapel (Matematika, IPA, dll)</p>
                        <p><strong>Kolom B:</strong> Pertanyaan (teks soal)</p>
                        <p><strong>Kolom C:</strong> Opsi A</p>
                        <p><strong>Kolom D:</strong> Opsi B</p>
                        <p><strong>Kolom E:</strong> Opsi C</p>
                        <p><strong>Kolom F:</strong> Opsi D</p>
                        <p><strong>Kolom G:</strong> Kunci (A/B/C/D)</p>
                        <p><strong>Kolom H:</strong> Gbr Pertanyaan (deskripsi/kosong)</p>
                        <p><strong>Kolom I:</strong> Gbr Opsi A (deskripsi/kosong)</p>
                        <p><strong>Kolom J:</strong> Gbr Opsi B (deskripsi/kosong)</p>
                        <p><strong>Kolom K:</strong> Gbr Opsi C (deskripsi/kosong)</p>
                        <p><strong>Kolom L:</strong> Gbr Opsi D (deskripsi/kosong)</p>
                    </div>
                    <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded">
                        <p class="text-xs text-green-700 font-medium">ü§ñ OTOMATIS: Sistem deteksi gambar secara otomatis!</p>
                        <p class="text-xs text-green-600">‚Ä¢ Ada isi di kolom gambar = tampilkan gambar</p>
                        <p class="text-xs text-green-600">‚Ä¢ Kosong = soal teks biasa</p>
                    </div>
                </div>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih File Excel</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                
                <div class="mt-4 text-xs text-gray-500">
                    <p>üí° Tips: Download template Excel terlebih dahulu untuk format yang benar</p>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="hideImportExcelModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                    Batal
                </button>
                <button onclick="importExcelFile()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Create Exam Modal -->
    <div id="createExamModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Buat Ujian Baru</h2>
            <form onsubmit="createExam(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Ujian</label>
                        <input type="text" id="newExamName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="newExamSubject" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Mata Pelajaran</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="IPA">IPA</option>
                            <option value="IPS">IPS</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                            <option value="PKn">PKn</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Durasi (menit)</label>
                        <input type="number" id="newExamDuration" min="30" max="180" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Soal</label>
                        <input type="number" id="newExamQuestions" min="10" max="50" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideCreateExamModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        Buat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xsmsirwgpifmsghgovel.supabase.co'; // Ganti dengan URL Supabase Anda
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzbXNpcndncGlmbXNnaGdvdmVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NDYzMDgsImV4cCI6MjA3MzMyMjMwOH0.P6zbM1-LSo5-c3a7FixalJ2oaRYP_-pVs5nBzD8AdIo'; // Ganti dengan Anon Key Supabase Anda
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let currentQuestion = 1;
        let totalQuestions = 20;
        let timeRemaining = 90 * 60; // 90 minutes in seconds
        let timer = null;
        let answers = {};
        let doubtQuestions = new Set();
        let startTime = null;

        // Sample questions with image support
        const originalQuestions = [
            {
                id: 1,
                question: "Jika 2x + 5 = 13, maka nilai x adalah...",
                options: ["3", "4", "5", "6"],
                type: "multiple_choice",
                hasImage: false
            },
            {
                id: 2,
                question: "Hasil dari ‚àö64 + ‚àö36 adalah...",
                options: ["10", "12", "14", "16"],
                type: "multiple_choice",
                hasImage: false
            },
            {
                id: 3,
                question: "Perhatikan gambar segitiga berikut. Berapakah luas segitiga tersebut?",
                questionImage: `<div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200">
                    <svg width="250" height="180" viewBox="0 0 250 180" class="mx-auto">
                        <!-- Triangle -->
                        <polygon points="50,150 200,150 125,50" fill="#dbeafe" stroke="#1e40af" stroke-width="3"/>
                        
                        <!-- Base line -->
                        <line x1="50" y1="150" x2="200" y2="150" stroke="#dc2626" stroke-width="2"/>
                        <text x="125" y="170" text-anchor="middle" class="text-lg font-bold fill-red-600">12 cm</text>
                        
                        <!-- Height line -->
                        <line x1="125" y1="50" x2="125" y2="150" stroke="#dc2626" stroke-width="2" stroke-dasharray="5,5"/>
                        <text x="105" y="100" text-anchor="middle" class="text-lg font-bold fill-red-600">8 cm</text>
                        
                        <!-- Right angle indicator -->
                        <path d="M 115 150 L 115 140 L 125 140" fill="none" stroke="#dc2626" stroke-width="2"/>
                        
                        <!-- Labels -->
                        <text x="125" y="30" text-anchor="middle" class="text-sm font-medium fill-blue-800">Tinggi = 8 cm</text>
                        <text x="125" y="190" text-anchor="middle" class="text-sm font-medium fill-blue-800">Alas = 12 cm</text>
                    </svg>
                    <p class="text-center text-sm text-blue-700 mt-2">üí° Rumus: Luas = ¬Ω √ó alas √ó tinggi</p>
                </div>`,
                options: ["48 cm¬≤", "96 cm¬≤", "24 cm¬≤", "32 cm¬≤"],
                type: "multiple_choice",
                hasImage: true
            },
            {
                id: 4,
                question: "Jika a = 3 dan b = 4, maka nilai a¬≤ + b¬≤ adalah...",
                options: ["25", "24", "23", "22"],
                type: "multiple_choice",
                hasImage: false
            },
            {
                id: 5,
                question: "Perhatikan diagram lingkaran berikut. Berapa persen bagian yang berwarna biru?",
                questionImage: `<div class="bg-gray-50 p-6 rounded-lg border-2 border-gray-200">
                    <svg width="220" height="220" viewBox="0 0 220 220" class="mx-auto">
                        <!-- Outer circle -->
                        <circle cx="110" cy="110" r="90" fill="#f3f4f6" stroke="#374151" stroke-width="2"/>
                        
                        <!-- Blue section (30%) -->
                        <path d="M 110 110 L 110 20 A 90 90 0 0 1 165.98 155.98 Z" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
                        
                        <!-- Labels -->
                        <text x="140" y="75" class="text-lg font-bold fill-white">30%</text>
                        <text x="75" y="140" class="text-lg font-bold fill-gray-700">70%</text>
                        
                        <!-- Center dot -->
                        <circle cx="110" cy="110" r="3" fill="#374151"/>
                        
                        <!-- Legend -->
                        <rect x="20" y="200" width="15" height="15" fill="#3b82f6"/>
                        <text x="40" y="212" class="text-sm font-medium">Bagian Biru</text>
                        <rect x="120" y="200" width="15" height="15" fill="#f3f4f6" stroke="#374151"/>
                        <text x="140" y="212" class="text-sm font-medium">Bagian Abu-abu</text>
                    </svg>
                </div>`,
                options: ["25%", "30%", "35%", "40%"],
                type: "multiple_choice",
                hasImage: true
            },
            {
                id: 6,
                question: "Manakah dari bangun datar berikut yang memiliki 4 sisi sama panjang?",
                options: [
                    {
                        text: "Persegi panjang",
                        image: `<div class="text-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <svg width="100" height="70" viewBox="0 0 100 70" class="mx-auto">
                                <rect x="15" y="20" width="70" height="30" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                <text x="50" y="45" text-anchor="middle" class="text-xs font-bold">6√ó4</text>
                            </svg>
                            <p class="text-xs mt-1 font-medium">Persegi Panjang</p>
                        </div>`
                    },
                    {
                        text: "Persegi",
                        image: `<div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                            <svg width="100" height="70" viewBox="0 0 100 70" class="mx-auto">
                                <rect x="25" y="20" width="50" height="30" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
                                <text x="50" y="45" text-anchor="middle" class="text-xs font-bold">5√ó5</text>
                            </svg>
                            <p class="text-xs mt-1 font-medium">Persegi</p>
                        </div>`
                    },
                    {
                        text: "Segitiga",
                        image: `<div class="text-center p-3 bg-pink-50 rounded-lg border border-pink-200">
                            <svg width="100" height="70" viewBox="0 0 100 70" class="mx-auto">
                                <polygon points="50,20 25,50 75,50" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
                                <text x="50" y="45" text-anchor="middle" class="text-xs font-bold">‚ñ≥</text>
                            </svg>
                            <p class="text-xs mt-1 font-medium">Segitiga</p>
                        </div>`
                    },
                    {
                        text: "Trapesium",
                        image: `<div class="text-center p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <svg width="100" height="70" viewBox="0 0 100 70" class="mx-auto">
                                <polygon points="30,20 70,20 80,50 20,50" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                                <text x="50" y="40" text-anchor="middle" class="text-xs font-bold">‚¨¢</text>
                            </svg>
                            <p class="text-xs mt-1 font-medium">Trapesium</p>
                        </div>`
                    }
                ],
                type: "multiple_choice_with_images",
                hasImage: false
            },
            {
                id: 7,
                question: "Perhatikan gambar jam berikut. Pukul berapa waktu yang ditunjukkan?",
                questionImage: `<div class="bg-white p-6 rounded-lg border-2 border-gray-300 shadow-lg">
                    <svg width="200" height="200" viewBox="0 0 200 200" class="mx-auto">
                        <!-- Clock face -->
                        <circle cx="100" cy="100" r="90" fill="#ffffff" stroke="#374151" stroke-width="3"/>
                        
                        <!-- Hour markers -->
                        <g stroke="#374151" stroke-width="2">
                            <line x1="100" y1="20" x2="100" y2="35" />
                            <line x1="170" y1="100" x2="155" y2="100" />
                            <line x1="100" y1="180" x2="100" y2="165" />
                            <line x1="30" y1="100" x2="45" y2="100" />
                        </g>
                        
                        <!-- Numbers -->
                        <text x="100" y="30" text-anchor="middle" class="text-lg font-bold">12</text>
                        <text x="175" y="105" text-anchor="middle" class="text-lg font-bold">3</text>
                        <text x="100" y="185" text-anchor="middle" class="text-lg font-bold">6</text>
                        <text x="25" y="105" text-anchor="middle" class="text-lg font-bold">9</text>
                        
                        <!-- Hour hand pointing to 3 -->
                        <line x1="100" y1="100" x2="140" y2="100" stroke="#dc2626" stroke-width="4" stroke-linecap="round"/>
                        
                        <!-- Minute hand pointing to 12 -->
                        <line x1="100" y1="100" x2="100" y2="50" stroke="#1e40af" stroke-width="3" stroke-linecap="round"/>
                        
                        <!-- Center dot -->
                        <circle cx="100" cy="100" r="5" fill="#374151"/>
                    </svg>
                    <p class="text-center text-sm text-gray-600 mt-2">üïí Jarum pendek = jam, Jarum panjang = menit</p>
                </div>`,
                options: ["03:00", "12:15", "15:00", "00:03"],
                type: "multiple_choice",
                hasImage: true
            },
            {
                id: 8,
                question: "Perhatikan pola bilangan berikut. Angka berapa yang harus mengisi kotak kosong?",
                questionImage: `<div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg border-2 border-blue-200">
                    <div class="flex justify-center items-center space-x-4">
                        <div class="w-16 h-16 bg-blue-500 text-white rounded-lg flex items-center justify-center text-2xl font-bold">2</div>
                        <div class="w-16 h-16 bg-blue-500 text-white rounded-lg flex items-center justify-center text-2xl font-bold">4</div>
                        <div class="w-16 h-16 bg-blue-500 text-white rounded-lg flex items-center justify-center text-2xl font-bold">6</div>
                        <div class="w-16 h-16 bg-blue-500 text-white rounded-lg flex items-center justify-center text-2xl font-bold">8</div>
                        <div class="w-16 h-16 bg-yellow-400 border-4 border-yellow-600 rounded-lg flex items-center justify-center text-2xl font-bold text-gray-800">?</div>
                    </div>
                    <p class="text-center text-sm text-blue-700 mt-4">üî¢ Temukan pola bilangan di atas!</p>
                </div>`,
                options: ["9", "10", "11", "12"],
                type: "multiple_choice",
                hasImage: true
            },
            {
                id: 9,
                question: "Perhatikan gambar pecahan berikut. Manakah yang menunjukkan 3/4?",
                options: [
                    {
                        text: "Gambar A",
                        image: `<div class="text-center p-3 bg-red-50 rounded-lg border border-red-200">
                            <svg width="100" height="60" viewBox="0 0 100 60" class="mx-auto">
                                <rect x="10" y="20" width="80" height="20" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
                                <rect x="10" y="20" width="40" height="20" fill="#dc2626"/>
                                <line x1="50" y1="20" x2="50" y2="40" stroke="#dc2626" stroke-width="2"/>
                            </svg>
                            <p class="text-xs mt-1">1/2 bagian</p>
                        </div>`
                    },
                    {
                        text: "Gambar B",
                        image: `<div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                            <svg width="100" height="60" viewBox="0 0 100 60" class="mx-auto">
                                <rect x="10" y="20" width="80" height="20" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
                                <rect x="10" y="20" width="60" height="20" fill="#22c55e"/>
                                <line x1="30" y1="20" x2="30" y2="40" stroke="#22c55e" stroke-width="2"/>
                                <line x1="50" y1="20" x2="50" y2="40" stroke="#22c55e" stroke-width="2"/>
                                <line x1="70" y1="20" x2="70" y2="40" stroke="#22c55e" stroke-width="2"/>
                            </svg>
                            <p class="text-xs mt-1">3/4 bagian</p>
                        </div>`
                    },
                    {
                        text: "Gambar C",
                        image: `<div class="text-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <svg width="100" height="60" viewBox="0 0 100 60" class="mx-auto">
                                <rect x="10" y="20" width="80" height="20" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                <rect x="10" y="20" width="20" height="20" fill="#3b82f6"/>
                                <line x1="30" y1="20" x2="30" y2="40" stroke="#3b82f6" stroke-width="2"/>
                                <line x1="50" y1="20" x2="50" y2="40" stroke="#3b82f6" stroke-width="2"/>
                                <line x1="70" y1="20" x2="70" y2="40" stroke="#3b82f6" stroke-width="2"/>
                            </svg>
                            <p class="text-xs mt-1">1/4 bagian</p>
                        </div>`
                    },
                    {
                        text: "Gambar D",
                        image: `<div class="text-center p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <svg width="100" height="60" viewBox="0 0 100 60" class="mx-auto">
                                <rect x="10" y="20" width="80" height="20" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
                                <rect x="10" y="20" width="80" height="20" fill="#6366f1"/>
                            </svg>
                            <p class="text-xs mt-1">4/4 bagian</p>
                        </div>`
                    }
                ],
                type: "multiple_choice_with_images",
                hasImage: false
            },
            {
                id: 10,
                question: "Perhatikan grafik batang berikut. Berapa jumlah siswa yang menyukai olahraga Basket?",
                questionImage: `<div class="bg-white p-6 rounded-lg border-2 border-gray-300">
                    <h4 class="text-center font-bold text-gray-800 mb-4">Olahraga Favorit Siswa Kelas 6</h4>
                    <svg width="300" height="200" viewBox="0 0 300 200" class="mx-auto">
                        <!-- Y-axis -->
                        <line x1="40" y1="20" x2="40" y2="160" stroke="#374151" stroke-width="2"/>
                        <!-- X-axis -->
                        <line x1="40" y1="160" x2="280" y2="160" stroke="#374151" stroke-width="2"/>
                        
                        <!-- Y-axis labels -->
                        <text x="30" y="160" text-anchor="end" class="text-xs">0</text>
                        <text x="30" y="140" text-anchor="end" class="text-xs">5</text>
                        <text x="30" y="120" text-anchor="end" class="text-xs">10</text>
                        <text x="30" y="100" text-anchor="end" class="text-xs">15</text>
                        <text x="30" y="80" text-anchor="end" class="text-xs">20</text>
                        
                        <!-- Bars -->
                        <!-- Sepak Bola: 15 siswa -->
                        <rect x="50" y="100" width="40" height="60" fill="#ef4444"/>
                        <text x="70" y="180" text-anchor="middle" class="text-xs">Sepak Bola</text>
                        <text x="70" y="95" text-anchor="middle" class="text-xs font-bold">15</text>
                        
                        <!-- Basket: 12 siswa -->
                        <rect x="100" y="112" width="40" height="48" fill="#3b82f6"/>
                        <text x="120" y="180" text-anchor="middle" class="text-xs">Basket</text>
                        <text x="120" y="107" text-anchor="middle" class="text-xs font-bold">12</text>
                        
                        <!-- Voli: 8 siswa -->
                        <rect x="150" y="128" width="40" height="32" fill="#22c55e"/>
                        <text x="170" y="180" text-anchor="middle" class="text-xs">Voli</text>
                        <text x="170" y="123" text-anchor="middle" class="text-xs font-bold">8</text>
                        
                        <!-- Badminton: 10 siswa -->
                        <rect x="200" y="120" width="40" height="40" fill="#f59e0b"/>
                        <text x="220" y="180" text-anchor="middle" class="text-xs">Badminton</text>
                        <text x="220" y="115" text-anchor="middle" class="text-xs font-bold">10</text>
                    </svg>
                    <p class="text-center text-sm text-gray-600 mt-2">üìä Grafik menunjukkan jumlah siswa per olahraga</p>
                </div>`,
                options: ["8 siswa", "10 siswa", "12 siswa", "15 siswa"],
                type: "multiple_choice",
                hasImage: true
            }
        ];

        // Generate more questions with varied content
        for (let i = 11; i <= 20; i++) {
            const questionTypes = [
                {
                    question: `Hasil dari ${i + 5} √ó ${i - 3} adalah...`,
                    options: [`${(i + 5) * (i - 3)}`, `${(i + 5) * (i - 3) + 5}`, `${(i + 5) * (i - 3) - 3}`, `${(i + 5) * (i - 3) + 10}`],
                    hasImage: false
                },
                {
                    question: `Jika sebuah persegi panjang memiliki panjang ${i + 2} cm dan lebar ${i} cm, maka kelilingnya adalah...`,
                    options: [`${2 * ((i + 2) + i)} cm`, `${2 * ((i + 2) + i) + 4} cm`, `${2 * ((i + 2) + i) - 2} cm`, `${(i + 2) * i} cm`],
                    hasImage: false
                },
                {
                    question: `Dalam sebuah kelas terdapat ${i + 10} siswa. Jika ${Math.floor((i + 10) / 3)} siswa perempuan, berapa siswa laki-laki?`,
                    options: [`${(i + 10) - Math.floor((i + 10) / 3)} siswa`, `${Math.floor((i + 10) / 3)} siswa`, `${i + 10} siswa`, `${(i + 10) + Math.floor((i + 10) / 3)} siswa`],
                    hasImage: false
                }
            ];
            
            const selectedType = questionTypes[i % 3];
            originalQuestions.push({
                id: i,
                question: selectedType.question,
                options: selectedType.options,
                type: "multiple_choice",
                hasImage: selectedType.hasImage
            });
        }

        // Randomization functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function randomizeQuestions(questions) {
            // Shuffle questions order
            const shuffledQuestions = shuffleArray(questions);
            
            // Shuffle options for each question
            return shuffledQuestions.map((question, index) => {
                const newQuestion = { ...question };
                newQuestion.displayId = index + 1; // New display number
                
                if (question.type === "multiple_choice" || question.type === "multiple_choice_with_images") {
                    const shuffledOptions = shuffleArray(question.options);
                    newQuestion.options = shuffledOptions;
                }
                
                return newQuestion;
            });
        }

        // Initialize randomized questions
        let questions = randomizeQuestions(originalQuestions);

        // Correct answers for scoring (based on original question IDs)
        const correctAnswers = {
            1: 1, // 2x + 5 = 13, x = 4 (index 1)
            2: 2, // ‚àö64 + ‚àö36 = 8 + 6 = 14 (index 2)
            3: 0, // Triangle area = (1/2 √ó 12 √ó 8) = 48 cm¬≤ (index 0)
            4: 0, // a¬≤ + b¬≤ = 9 + 16 = 25 (index 0)
            5: 1, // Blue section is 30% (index 1)
            6: 1, // Persegi has 4 equal sides (index 1)
            7: 0, // Clock shows 03:00 (index 0)
            8: 1, // Pattern: 2,4,6,8,10 (index 1)
            9: 1, // 3/4 fraction is Gambar B (index 1)
            10: 2, // Basket has 12 students (index 2)
            11: 0, // Math calculations - first option is correct
            12: 0,
            13: 0,
            14: 0,
            15: 0,
            16: 0,
            17: 0,
            18: 0,
            19: 0,
            20: 0
        };

        function calculateScore() {
            let correct = 0;
            let incorrect = 0;
            
            // Check each answered question
            for (let questionNum in answers) {
                const userAnswer = answers[questionNum];
                const question = questions[questionNum - 1];
                const originalId = question.id;
                
                // Find the correct answer index in the shuffled options
                let correctAnswerIndex = -1;
                if (question.type === "multiple_choice_with_images") {
                    // For image questions, find the correct option by text content
                    const correctOptionText = originalQuestions[originalId - 1].options[correctAnswers[originalId]].text;
                    correctAnswerIndex = question.options.findIndex(option => option.text === correctOptionText);
                } else {
                    // For regular questions, find the correct option by text content
                    const correctOptionText = originalQuestions[originalId - 1].options[correctAnswers[originalId]];
                    correctAnswerIndex = question.options.findIndex(option => option === correctOptionText);
                }
                
                if (userAnswer === correctAnswerIndex) {
                    correct++;
                } else {
                    incorrect++;
                }
            }
            
            const totalAnswered = correct + incorrect;
            const score = totalAnswered > 0 ? Math.round((correct / totalQuestions) * 100) : 0;
            
            let grade = 'E';
            if (score >= 90) grade = 'A';
            else if (score >= 80) grade = 'B';
            else if (score >= 70) grade = 'C';
            else if (score >= 60) grade = 'D';
            
            return {
                score: score,
                correct: correct,
                incorrect: incorrect,
                grade: grade
            };
        }

        function autoFillStudent() {
            document.getElementById('username').value = '1234567890';
            document.getElementById('password').value = 'min2025';
            
            // Add visual feedback
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            
            usernameField.classList.add('bg-green-50', 'border-green-300');
            passwordField.classList.add('bg-green-50', 'border-green-300');
            
            setTimeout(() => {
                usernameField.classList.remove('bg-green-50', 'border-green-300');
                passwordField.classList.remove('bg-green-50', 'border-green-300');
            }, 1000);
        }

        function autoFillAdmin() {
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            
            // Add visual feedback
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            
            usernameField.classList.add('bg-blue-50', 'border-blue-300');
            passwordField.classList.add('bg-blue-50', 'border-blue-300');
            
            setTimeout(() => {
                usernameField.classList.remove('bg-blue-50', 'border-blue-300');
                passwordField.classList.remove('bg-blue-50', 'border-blue-300');
            }, 1000);
        }

        function handleSmartLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Smart detection logic
            const isNISN = /^\d{10}$/.test(username); // 10 digit number = NISN
            const isAdmin = username.toLowerCase() === 'admin' || username.toLowerCase().includes('admin');
            
            if (isNISN) {
                // Student login
                if (username === '1234567890' && password === 'min2025') {
                    document.getElementById('participantName').textContent = 'Ahmad Rizki';
                    showScreen('cbtInterface');
                    initializeCBT();
                    
                    // Show success message
                    showLoginSuccess('üë®‚Äçüéì Login Siswa Berhasil!', 'Selamat datang di CBT MIN Singkawang');
                } else {
                    alert('‚ùå NISN atau Password siswa salah!\n\n‚úÖ Gunakan kredensial demo:\nNISN: 1234567890\nPassword: min2025\n\nAtau klik tombol "Auto Fill Siswa"');
                }
            } else if (isAdmin) {
                // Admin login
                if (username === 'admin' && password === 'admin123') {
                    showScreen('adminDashboard');
                    initializeAdminDashboard();
                    
                    // Show success message
                    showLoginSuccess('üîß Login Admin Berhasil!', 'Selamat datang di Panel Administrasi');
                } else {
                    alert('‚ùå Username atau Password admin salah!\n\n‚úÖ Gunakan kredensial demo:\nUsername: admin\nPassword: admin123\n\nAtau klik tombol "Auto Fill Admin"');
                }
            } else {
                // Try to find student by name or other identifier
                const student = adminData.students.find(s => 
                    s.name.toLowerCase().includes(username.toLowerCase()) ||
                    s.nisn === username
                );
                
                if (student && student.password === password) {
                    document.getElementById('participantName').textContent = student.name;
                    showScreen('cbtInterface');
                    initializeCBT();
                    
                    showLoginSuccess('üë®‚Äçüéì Login Siswa Berhasil!', `Selamat datang ${student.name}`);
                } else {
                    alert('‚ùå Username/NISN atau Password tidak ditemukan!\n\nüí° Tips:\n‚Ä¢ Gunakan NISN 10 digit untuk login siswa\n‚Ä¢ Gunakan "admin" untuk login administrator\n‚Ä¢ Atau coba kredensial demo di bawah');
                }
            }
        }

        function showLoginSuccess(title, message) {
            // Create temporary success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-lg">‚úÖ</span>
                    <div>
                        <div class="font-semibold">${title}</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function showScreen(screenId) {
            const screens = ['loginScreen', 'cbtInterface', 'resultScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function initializeCBT() {
            startTime = new Date();
            generateQuestionNavigation();
            loadQuestion(1);
            startTimer();
        }

        function toggleMobileNav() {
            const nav = document.querySelector('.question-nav');
            const overlay = document.querySelector('.mobile-overlay');
            nav.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function closeMobileNav() {
            const nav = document.querySelector('.question-nav');
            const overlay = document.querySelector('.mobile-overlay');
            nav.classList.remove('show');
            overlay.classList.remove('show');
        }

        function generateQuestionNavigation() {
            const nav = document.getElementById('questionNavigation');
            nav.innerHTML = '';
            
            for (let i = 1; i <= totalQuestions; i++) {
                const btn = document.createElement('div');
                btn.className = `question-number ${i === 1 ? 'current' : 'unanswered'}`;
                btn.textContent = i;
                btn.onclick = () => {
                    loadQuestion(i);
                    closeMobileNav(); // Close mobile nav when question is selected
                };
                nav.appendChild(btn);
            }
        }

        function loadQuestion(questionNumber) {
            currentQuestion = questionNumber;
            const question = questions[questionNumber - 1];
            
            // Update navigation
            document.querySelectorAll('.question-number').forEach((btn, index) => {
                btn.classList.remove('current');
                if (index + 1 === questionNumber) {
                    btn.classList.add('current');
                }
            });
            
            // Generate question image if exists
            const questionImageHtml = question.hasImage && question.questionImage ? 
                `<div class="mb-6 text-center">${question.questionImage}</div>` : '';
            
            // Generate options based on type
            let optionsHtml = '';
            if (question.type === "multiple_choice_with_images") {
                optionsHtml = question.options.map((option, index) => `
                    <button class="option-button w-full text-left p-4 rounded-lg bg-white flex items-center space-x-4 ${answers[questionNumber] === index ? 'selected' : ''}" 
                            onclick="selectAnswer(${questionNumber}, ${index})">
                        <div class="flex-shrink-0">${option.image}</div>
                        <div class="flex-1">
                            <span class="font-medium">${String.fromCharCode(65 + index)}.</span> ${option.text}
                        </div>
                    </button>
                `).join('');
            } else {
                optionsHtml = question.options.map((option, index) => `
                    <button class="option-button w-full text-left p-4 rounded-lg bg-white ${answers[questionNumber] === index ? 'selected' : ''}" 
                            onclick="selectAnswer(${questionNumber}, ${index})">
                        <span class="font-medium">${String.fromCharCode(65 + index)}.</span> ${option}
                    </button>
                `).join('');
            }
            
            // Update question content
            const container = document.getElementById('questionContainer');
            container.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Soal ${questionNumber}</h2>
                        <span class="text-sm text-gray-500">${questionNumber} dari ${totalQuestions}</span>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-gray-800 leading-relaxed">${question.question}</p>
                        ${questionImageHtml}
                    </div>
                    
                    <div class="space-y-3">
                        ${optionsHtml}
                    </div>
                    
                    ${question.type === "multiple_choice_with_images" ? 
                        '<div class="mt-4 text-xs text-gray-500 text-center">üí° Pilih gambar yang sesuai dengan jawaban</div>' : ''}
                </div>
            `;
            
            // Update current question number
            document.getElementById('currentQuestionNumber').textContent = questionNumber;
            
            // Add fade-in animation
            container.classList.remove('fade-in');
            setTimeout(() => container.classList.add('fade-in'), 10);
        }

        function selectAnswer(questionNumber, answer) {
            answers[questionNumber] = answer;
            
            // Update option buttons
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Update navigation button status
            const navBtn = document.querySelectorAll('.question-number')[questionNumber - 1];
            navBtn.classList.remove('unanswered');
            navBtn.classList.add('answered');
            
            // Remove from doubt if it was marked
            if (doubtQuestions.has(questionNumber)) {
                doubtQuestions.delete(questionNumber);
                navBtn.classList.remove('doubt');
            }
            
            updateStats();
        }

        function markAsDoubt() {
            if (doubtQuestions.has(currentQuestion)) {
                doubtQuestions.delete(currentQuestion);
            } else {
                doubtQuestions.add(currentQuestion);
            }
            
            const navBtn = document.querySelectorAll('.question-number')[currentQuestion - 1];
            if (doubtQuestions.has(currentQuestion)) {
                navBtn.classList.add('doubt');
            } else {
                navBtn.classList.remove('doubt');
            }
            
            updateStats();
        }

        function previousQuestion() {
            if (currentQuestion > 1) {
                loadQuestion(currentQuestion - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestion < totalQuestions) {
                loadQuestion(currentQuestion + 1);
            }
        }

        function updateStats() {
            const answeredCount = Object.keys(answers).length;
            const doubtCount = doubtQuestions.size;
            
            // Update desktop stats
            const desktopAnswered = document.getElementById('answeredCount');
            const desktopDoubt = document.getElementById('doubtCount');
            const desktopCurrent = document.getElementById('currentQuestionNumber');
            
            if (desktopAnswered) desktopAnswered.textContent = answeredCount;
            if (desktopDoubt) desktopDoubt.textContent = doubtCount;
            if (desktopCurrent) desktopCurrent.textContent = currentQuestion;
            
            // Update mobile stats
            const mobileAnswered = document.getElementById('mobileAnsweredCount');
            const mobileDoubt = document.getElementById('mobileDoubtCount');
            const mobileCurrent = document.getElementById('mobileCurrentQuestionNumber');
            
            if (mobileAnswered) mobileAnswered.textContent = answeredCount;
            if (mobileDoubt) mobileDoubt.textContent = doubtCount;
            if (mobileCurrent) mobileCurrent.textContent = currentQuestion;
        }

        function startTimer() {
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    autoSubmitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer').textContent = timeString;
            
            // Add warning class when time is running out
            const timerElement = document.getElementById('timer');
            if (timeRemaining <= 300) { // 5 minutes
                timerElement.classList.add('timer-warning');
                timerElement.parentElement.classList.add('bg-red-500');
                timerElement.parentElement.classList.remove('bg-white', 'bg-opacity-20');
            } else if (timeRemaining <= 600) { // 10 minutes
                timerElement.parentElement.classList.add('bg-yellow-500');
                timerElement.parentElement.classList.remove('bg-white', 'bg-opacity-20');
            }
        }

        function showSubmitConfirmation() {
            const answeredCount = Object.keys(answers).length;
            const unansweredCount = totalQuestions - answeredCount;
            const doubtCount = doubtQuestions.size;
            
            document.getElementById('modalAnsweredCount').textContent = answeredCount;
            document.getElementById('modalUnansweredCount').textContent = unansweredCount;
            document.getElementById('modalDoubtCount').textContent = doubtCount;
            
            document.getElementById('submitModal').classList.remove('hidden');
        }

        function hideSubmitConfirmation() {
            document.getElementById('submitModal').classList.add('hidden');
        }

        function submitExam() {
            // Hide the modal first
            document.getElementById('submitModal').classList.add('hidden');
            
            clearInterval(timer);
            
            const endTime = new Date();
            const duration = Math.floor((endTime - startTime) / 1000);
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;
            
            const timeUsed = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Calculate score
            const score = calculateScore();
            
            document.getElementById('finalAnsweredCount').textContent = Object.keys(answers).length;
            document.getElementById('finalTime').textContent = timeUsed;
            document.getElementById('finalScore').textContent = score.score;
            document.getElementById('finalCorrect').textContent = score.correct;
            document.getElementById('finalIncorrect').textContent = score.incorrect;
            document.getElementById('finalGrade').textContent = score.grade;
            
            showScreen('resultScreen');
        }

        function autoSubmitExam() {
            alert('Waktu habis! Ujian akan dikumpulkan otomatis.');
            submitExam();
        }

        // Prevent common shortcuts and right-click
        document.addEventListener('keydown', function(e) {
            // Prevent F12, Ctrl+Shift+I, Ctrl+U, etc.
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.key === 'u') ||
                (e.ctrlKey && e.key === 's') ||
                (e.altKey && e.key === 'Tab')) {
                e.preventDefault();
                return false;
            }
        });

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Prevent text selection
        document.addEventListener('selectstart', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                return false;
            }
        });

        // Database Functions
        async function initializeDatabase() {
            try {
                // Create tables if they don't exist
                await createTables();
                
                // Load initial data if tables are empty
                await loadInitialData();
                
                console.log('‚úÖ Database initialized successfully');
            } catch (error) {
                console.error('‚ùå Database initialization error:', error);
                // Fallback to local data if database fails
                useLocalData();
            }
        }

        async function createTables() {
            // Note: Tables should be created in Supabase dashboard or via SQL
            // This is just for reference of the expected structure
            
            /*
            SQL untuk membuat tabel di Supabase:
            
            -- Tabel Students
            CREATE TABLE students (
                id SERIAL PRIMARY KEY,
                nisn VARCHAR(10) UNIQUE NOT NULL,
                name VARCHAR(100) NOT NULL,
                class VARCHAR(10) NOT NULL,
                password VARCHAR(100) NOT NULL,
                status VARCHAR(20) DEFAULT 'Aktif',
                created_at TIMESTAMP DEFAULT NOW()
            );
            
            -- Tabel Questions
            CREATE TABLE questions (
                id SERIAL PRIMARY KEY,
                question TEXT NOT NULL,
                option_a TEXT NOT NULL,
                option_b TEXT NOT NULL,
                option_c TEXT NOT NULL,
                option_d TEXT NOT NULL,
                correct_answer INTEGER NOT NULL,
                subject VARCHAR(50) NOT NULL,
                question_type VARCHAR(50) DEFAULT 'multiple_choice',
                has_image BOOLEAN DEFAULT FALSE,
                question_image TEXT,
                created_at TIMESTAMP DEFAULT NOW()
            );
            
            -- Tabel Exams
            CREATE TABLE exams (
                id SERIAL PRIMARY KEY,
                name VARCHAR(200) NOT NULL,
                subject VARCHAR(50) NOT NULL,
                duration INTEGER NOT NULL,
                total_questions INTEGER NOT NULL,
                status VARCHAR(20) DEFAULT 'Aktif',
                created_at TIMESTAMP DEFAULT NOW()
            );
            
            -- Tabel Results
            CREATE TABLE results (
                id SERIAL PRIMARY KEY,
                student_nisn VARCHAR(10) REFERENCES students(nisn),
                exam_id INTEGER REFERENCES exams(id),
                score INTEGER NOT NULL,
                grade VARCHAR(2) NOT NULL,
                correct_answers INTEGER NOT NULL,
                total_questions INTEGER NOT NULL,
                time_used VARCHAR(10) NOT NULL,
                answers JSONB,
                created_at TIMESTAMP DEFAULT NOW()
            );
            */
        }

        async function loadInitialData() {
            // Check if students table has data
            const { data: students, error: studentsError } = await supabase
                .from('students')
                .select('*')
                .limit(1);
                
            if (!studentsError && students.length === 0) {
                // Insert initial students
                await supabase.from('students').insert([
                    { nisn: '1234567890', name: 'Ahmad Rizki', class: '6A', password: 'min2025', status: 'Aktif' },
                    { nisn: '1234567891', name: 'Siti Aminah', class: '6A', password: 'min2025', status: 'Aktif' },
                    { nisn: '1234567892', name: 'Budi Santoso', class: '6B', password: 'min2025', status: 'Aktif' }
                ]);
            }
            
            // Check if questions table has data
            const { data: questions, error: questionsError } = await supabase
                .from('questions')
                .select('*')
                .limit(1);
                
            if (!questionsError && questions.length === 0) {
                // Insert initial questions
                await insertInitialQuestions();
            }
            
            // Check if exams table has data
            const { data: exams, error: examsError } = await supabase
                .from('exams')
                .select('*')
                .limit(1);
                
            if (!examsError && exams.length === 0) {
                // Insert initial exam
                await supabase.from('exams').insert([
                    { name: 'Ujian Matematika Semester 1', subject: 'Matematika', duration: 90, total_questions: 20, status: 'Aktif' }
                ]);
            }
        }

        async function insertInitialQuestions() {
            const initialQuestions = [
                {
                    question: "Jika 2x + 5 = 13, maka nilai x adalah...",
                    option_a: "3", option_b: "4", option_c: "5", option_d: "6",
                    correct_answer: 1, subject: "Matematika", question_type: "multiple_choice"
                },
                {
                    question: "Hasil dari ‚àö64 + ‚àö36 adalah...",
                    option_a: "10", option_b: "12", option_c: "14", option_d: "16",
                    correct_answer: 2, subject: "Matematika", question_type: "multiple_choice"
                },
                {
                    question: "Perhatikan gambar segitiga berikut:",
                    option_a: "48 cm¬≤", option_b: "96 cm¬≤", option_c: "24 cm¬≤", option_d: "32 cm¬≤",
                    correct_answer: 0, subject: "Matematika", question_type: "multiple_choice", has_image: true
                }
            ];
            
            // Add more questions
            for (let i = 4; i <= 20; i++) {
                initialQuestions.push({
                    question: `Soal matematika nomor ${i}. Tentukan hasil dari operasi berikut...`,
                    option_a: "Pilihan A", option_b: "Pilihan B", option_c: "Pilihan C", option_d: "Pilihan D",
                    correct_answer: 1, subject: "Matematika", question_type: "multiple_choice"
                });
            }
            
            await supabase.from('questions').insert(initialQuestions);
        }

        function useLocalData() {
            console.log('üîÑ Using local data as fallback');
            // Keep the existing adminData structure as fallback
        }

        // Admin Data Storage (Fallback)
        let adminData = {
            students: [
                { nisn: '1234567890', name: 'Ahmad Rizki', class: '6A', password: 'min2025', status: 'Aktif' },
                { nisn: '1234567891', name: 'Siti Aminah', class: '6A', password: 'min2025', status: 'Aktif' },
                { nisn: '1234567892', name: 'Budi Santoso', class: '6B', password: 'min2025', status: 'Aktif' }
            ],
            exams: [
                { id: 1, name: 'Ujian Matematika Semester 1', subject: 'Matematika', duration: 90, questions: 20, status: 'Aktif' }
            ],
            results: [
                { nisn: '1234567890', name: 'Ahmad Rizki', exam: 'Ujian Matematika Semester 1', score: 85, grade: 'B', time: '01:15:30', date: '2024-01-15' }
            ]
        };

        // Excel Import/Export Functions
        function showImportExcelModal() {
            document.getElementById('importExcelModal').classList.remove('hidden');
        }

        function hideImportExcelModal() {
            document.getElementById('importExcelModal').classList.add('hidden');
            document.getElementById('excelFile').value = '';
        }

        function downloadExcelTemplate() {
            // Create simple and intuitive template data
            const templateData = [
                {
                    'Mapel': 'Matematika',
                    'Pertanyaan': 'Jika 2x + 5 = 13, maka nilai x adalah...',
                    'Opsi A': '3',
                    'Opsi B': '4',
                    'Opsi C': '5',
                    'Opsi D': '6',
                    'Kunci': 'B',
                    'Gbr Pertanyaan': '',
                    'Gbr Opsi A': '',
                    'Gbr Opsi B': '',
                    'Gbr Opsi C': '',
                    'Gbr Opsi D': ''
                },
                {
                    'Mapel': 'Matematika',
                    'Pertanyaan': 'Hasil dari ‚àö64 + ‚àö36 adalah...',
                    'Opsi A': '10',
                    'Opsi B': '12',
                    'Opsi C': '14',
                    'Opsi D': '16',
                    'Kunci': 'C',
                    'Gbr Pertanyaan': '',
                    'Gbr Opsi A': '',
                    'Gbr Opsi B': '',
                    'Gbr Opsi C': '',
                    'Gbr Opsi D': ''
                },
                {
                    'Mapel': 'Matematika',
                    'Pertanyaan': 'Berapakah luas segitiga dengan alas 12 cm dan tinggi 8 cm?',
                    'Opsi A': '48 cm¬≤',
                    'Opsi B': '96 cm¬≤',
                    'Opsi C': '24 cm¬≤',
                    'Opsi D': '32 cm¬≤',
                    'Kunci': 'A',
                    'Gbr Pertanyaan': 'Segitiga dengan alas 12 cm dan tinggi 8 cm',
                    'Gbr Opsi A': '',
                    'Gbr Opsi B': '',
                    'Gbr Opsi C': '',
                    'Gbr Opsi D': ''
                },
                {
                    'Mapel': 'Matematika',
                    'Pertanyaan': 'Manakah bangun datar yang memiliki 4 sisi sama panjang?',
                    'Opsi A': 'Persegi panjang',
                    'Opsi B': 'Persegi',
                    'Opsi C': 'Segitiga',
                    'Opsi D': 'Trapesium',
                    'Kunci': 'B',
                    'Gbr Pertanyaan': '',
                    'Gbr Opsi A': 'Gambar persegi panjang',
                    'Gbr Opsi B': 'Gambar persegi',
                    'Gbr Opsi C': 'Gambar segitiga',
                    'Gbr Opsi D': 'Gambar trapesium'
                },
                {
                    'Mapel': 'Matematika',
                    'Pertanyaan': 'Pukul berapa waktu yang ditunjukkan jam ini?',
                    'Opsi A': '03:00',
                    'Opsi B': '12:15',
                    'Opsi C': '15:00',
                    'Opsi D': '00:03',
                    'Kunci': 'A',
                    'Gbr Pertanyaan': 'Jam analog menunjuk pukul 3',
                    'Gbr Opsi A': '',
                    'Gbr Opsi B': '',
                    'Gbr Opsi C': '',
                    'Gbr Opsi D': ''
                },
                {
                    'Mapel': 'IPA',
                    'Pertanyaan': 'Manakah yang termasuk hewan mamalia?',
                    'Opsi A': 'Ikan',
                    'Opsi B': 'Burung',
                    'Opsi C': 'Kucing',
                    'Opsi D': 'Ular',
                    'Kunci': 'C',
                    'Gbr Pertanyaan': '',
                    'Gbr Opsi A': 'Gambar ikan',
                    'Gbr Opsi B': 'Gambar burung',
                    'Gbr Opsi C': 'Gambar kucing',
                    'Gbr Opsi D': 'Gambar ular'
                }
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(templateData);

            // Set column widths for better readability
            ws['!cols'] = [
                { wch: 15 }, // Mapel
                { wch: 50 }, // Pertanyaan
                { wch: 20 }, // Opsi A
                { wch: 20 }, // Opsi B
                { wch: 20 }, // Opsi C
                { wch: 20 }, // Opsi D
                { wch: 8 },  // Kunci
                { wch: 30 }, // Gbr Pertanyaan
                { wch: 25 }, // Gbr Opsi A
                { wch: 25 }, // Gbr Opsi B
                { wch: 25 }, // Gbr Opsi C
                { wch: 25 }  // Gbr Opsi D
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Template Soal CBT');

            // Save file
            XLSX.writeFile(wb, 'Template_Soal_CBT_Sederhana.xlsx');
            
            // Show success message
            showNotification('‚úÖ Template Excel sederhana berhasil didownload!', 'success');
        }

        async function importExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file Excel terlebih dahulu!');
                return;
            }

            try {
                const data = await readExcelFile(file);
                const questions = parseExcelData(data);
                
                if (questions.length === 0) {
                    alert('Tidak ada data soal yang valid ditemukan!');
                    return;
                }

                // Import to database
                await importQuestionsToDatabase(questions);
                
                // Refresh questions table
                await loadQuestionsFromDatabase();
                
                hideImportExcelModal();
                showNotification(`‚úÖ Berhasil import ${questions.length} soal dari Excel!`, 'success');
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Gagal import file Excel. Pastikan format file sesuai template!');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseExcelData(data) {
            const questions = [];
            
            data.forEach((row, index) => {
                try {
                    // Check required fields with new simple format
                    if (!row['Pertanyaan'] || !row['Opsi A'] || !row['Opsi B'] || 
                        !row['Opsi C'] || !row['Opsi D'] || !row['Kunci']) {
                        console.warn(`Row ${index + 2}: Missing required fields`);
                        return;
                    }

                    // Convert answer letter to index
                    const answerLetter = row['Kunci'].toString().toUpperCase();
                    let correctAnswer;
                    switch(answerLetter) {
                        case 'A': correctAnswer = 0; break;
                        case 'B': correctAnswer = 1; break;
                        case 'C': correctAnswer = 2; break;
                        case 'D': correctAnswer = 3; break;
                        default:
                            console.warn(`Row ${index + 2}: Invalid answer format`);
                            return;
                    }

                    // Auto-detect image presence and type
                    const hasQuestionImage = row['Gbr Pertanyaan'] && row['Gbr Pertanyaan'].toString().trim() !== '';
                    const hasOptionImages = (row['Gbr Opsi A'] && row['Gbr Opsi A'].toString().trim() !== '') ||
                                          (row['Gbr Opsi B'] && row['Gbr Opsi B'].toString().trim() !== '') ||
                                          (row['Gbr Opsi C'] && row['Gbr Opsi C'].toString().trim() !== '') ||
                                          (row['Gbr Opsi D'] && row['Gbr Opsi D'].toString().trim() !== '');

                    // Determine question type automatically
                    let questionType = 'multiple_choice';
                    if (hasOptionImages) {
                        questionType = 'multiple_choice_with_images';
                    }

                    const question = {
                        question: row['Pertanyaan'].toString().trim(),
                        option_a: row['Opsi A'].toString().trim(),
                        option_b: row['Opsi B'].toString().trim(),
                        option_c: row['Opsi C'].toString().trim(),
                        option_d: row['Opsi D'].toString().trim(),
                        correct_answer: correctAnswer,
                        subject: row['Mapel'] ? row['Mapel'].toString().trim() : 'Umum',
                        question_type: questionType,
                        has_image: hasQuestionImage || hasOptionImages,
                        question_image: hasQuestionImage ? row['Gbr Pertanyaan'].toString().trim() : null,
                        option_images: {
                            a: row['Gbr Opsi A'] ? row['Gbr Opsi A'].toString().trim() : null,
                            b: row['Gbr Opsi B'] ? row['Gbr Opsi B'].toString().trim() : null,
                            c: row['Gbr Opsi C'] ? row['Gbr Opsi C'].toString().trim() : null,
                            d: row['Gbr Opsi D'] ? row['Gbr Opsi D'].toString().trim() : null
                        }
                    };

                    questions.push(question);
                    console.log(`‚úÖ Row ${index + 2}: Parsed successfully - Type: ${questionType}, Images: ${hasQuestionImage ? 'Question' : ''}${hasOptionImages ? ' Options' : ''}`);
                } catch (error) {
                    console.warn(`‚ùå Row ${index + 2}: Parse error`, error);
                }
            });

            return questions;
        }

        async function importQuestionsToDatabase(questions) {
            try {
                const { data, error } = await supabase
                    .from('questions')
                    .insert(questions);
                    
                if (error) throw error;
                
                return data;
            } catch (error) {
                console.error('Database import error:', error);
                // Fallback to local storage with enhanced image support
                questions.forEach(q => {
                    const newId = originalQuestions.length + 1;
                    
                    // Create options array with image support
                    let options = [q.option_a, q.option_b, q.option_c, q.option_d];
                    
                    // If it's a multiple choice with images, create image objects
                    if (q.question_type === 'multiple_choice_with_images') {
                        options = [
                            {
                                text: q.option_a,
                                image: q.option_images.a ? generateImagePlaceholder(q.option_images.a, 'A') : null
                            },
                            {
                                text: q.option_b,
                                image: q.option_images.b ? generateImagePlaceholder(q.option_images.b, 'B') : null
                            },
                            {
                                text: q.option_c,
                                image: q.option_images.c ? generateImagePlaceholder(q.option_images.c, 'C') : null
                            },
                            {
                                text: q.option_d,
                                image: q.option_images.d ? generateImagePlaceholder(q.option_images.d, 'D') : null
                            }
                        ];
                    }
                    
                    const newQuestion = {
                        id: newId,
                        question: q.question,
                        options: options,
                        type: q.question_type,
                        hasImage: q.has_image,
                        questionImage: q.question_image ? generateImagePlaceholder(q.question_image, 'Question') : null
                    };
                    
                    originalQuestions.push(newQuestion);
                    correctAnswers[newId] = q.correct_answer;
                    
                    console.log(`‚úÖ Added question ${newId}: ${q.question_type} with ${q.has_image ? 'images' : 'text only'}`);
                });
                
                // Regenerate randomized questions
                questions = randomizeQuestions(originalQuestions);
                totalQuestions = questions.length;
                
                console.log(`üîÑ Total questions updated: ${totalQuestions}`);
            }
        }

        // Helper function to generate image placeholders based on description
        function generateImagePlaceholder(description, type) {
            const colors = {
                'A': '#ef4444', 'B': '#22c55e', 'C': '#3b82f6', 'D': '#f59e0b', 'Question': '#6366f1'
            };
            const color = colors[type] || '#6b7280';
            
            // Generate appropriate SVG based on description keywords
            if (description.toLowerCase().includes('segitiga')) {
                return `<div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <svg width="100" height="80" viewBox="0 0 100 80" class="mx-auto">
                        <polygon points="50,10 20,70 80,70" fill="${color}20" stroke="${color}" stroke-width="2"/>
                        <text x="50" y="85" text-anchor="middle" class="text-xs font-medium">${description}</text>
                    </svg>
                </div>`;
            } else if (description.toLowerCase().includes('persegi')) {
                return `<div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <svg width="100" height="80" viewBox="0 0 100 80" class="mx-auto">
                        <rect x="25" y="20" width="50" height="40" fill="${color}20" stroke="${color}" stroke-width="2"/>
                        <text x="50" y="85" text-anchor="middle" class="text-xs font-medium">${description}</text>
                    </svg>
                </div>`;
            } else if (description.toLowerCase().includes('lingkaran') || description.toLowerCase().includes('bulat')) {
                return `<div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <svg width="100" height="80" viewBox="0 0 100 80" class="mx-auto">
                        <circle cx="50" cy="40" r="25" fill="${color}20" stroke="${color}" stroke-width="2"/>
                        <text x="50" y="85" text-anchor="middle" class="text-xs font-medium">${description}</text>
                    </svg>
                </div>`;
            } else if (description.toLowerCase().includes('jam')) {
                return `<div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <svg width="100" height="80" viewBox="0 0 100 80" class="mx-auto">
                        <circle cx="50" cy="40" r="25" fill="white" stroke="${color}" stroke-width="2"/>
                        <line x1="50" y1="40" x2="50" y2="25" stroke="${color}" stroke-width="2"/>
                        <line x1="50" y1="40" x2="65" y2="40" stroke="${color}" stroke-width="1"/>
                        <text x="50" y="85" text-anchor="middle" class="text-xs font-medium">${description}</text>
                    </svg>
                </div>`;
            } else {
                // Generic placeholder
                return `<div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="w-20 h-16 mx-auto bg-gradient-to-br from-${color}20 to-${color}10 rounded-lg flex items-center justify-center border-2 border-${color}30">
                        <span class="text-2xl">üñºÔ∏è</span>
                    </div>
                    <p class="text-xs mt-2 font-medium text-gray-700">${description}</p>
                </div>`;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Admin Functions (integrated with smart login)

        async function initializeAdminDashboard() {
            try {
                await loadStudentsFromDatabase();
                await loadQuestionsFromDatabase();
                await loadExamsFromDatabase();
                await loadResultsFromDatabase();
                updateAdminStats();
                showAdminSection('dashboard');
            } catch (error) {
                console.error('Admin dashboard initialization error:', error);
                // Fallback to local data
                updateAdminStats();
                loadStudentsTable();
                loadQuestionsTable();
                loadExamsTable();
                loadResultsTable();
                showAdminSection('dashboard');
            }
        }

        // Database integration functions
        async function loadStudentsFromDatabase() {
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                adminData.students = data || [];
                loadStudentsTable();
            } catch (error) {
                console.error('Load students error:', error);
                loadStudentsTable(); // Use local data
            }
        }

        async function loadQuestionsFromDatabase() {
            try {
                const { data, error } = await supabase
                    .from('questions')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                // Convert database format to local format
                originalQuestions.length = 0; // Clear existing
                correctAnswers = {};
                
                data.forEach(q => {
                    originalQuestions.push({
                        id: q.id,
                        question: q.question,
                        options: [q.option_a, q.option_b, q.option_c, q.option_d],
                        type: q.question_type,
                        hasImage: q.has_image,
                        questionImage: q.question_image
                    });
                    correctAnswers[q.id] = q.correct_answer;
                });
                
                // Regenerate randomized questions
                questions = randomizeQuestions(originalQuestions);
                totalQuestions = questions.length;
                
                loadQuestionsTable();
            } catch (error) {
                console.error('Load questions error:', error);
                loadQuestionsTable(); // Use local data
            }
        }

        async function loadExamsFromDatabase() {
            try {
                const { data, error } = await supabase
                    .from('exams')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                adminData.exams = data || [];
                loadExamsTable();
            } catch (error) {
                console.error('Load exams error:', error);
                loadExamsTable(); // Use local data
            }
        }

        async function loadResultsFromDatabase() {
            try {
                const { data, error } = await supabase
                    .from('results')
                    .select(`
                        *,
                        students(name),
                        exams(name)
                    `)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                // Convert to local format
                adminData.results = data.map(r => ({
                    nisn: r.student_nisn,
                    name: r.students?.name || 'Unknown',
                    exam: r.exams?.name || 'Unknown Exam',
                    score: r.score,
                    grade: r.grade,
                    time: r.time_used,
                    date: new Date(r.created_at).toLocaleDateString('id-ID')
                }));
                
                loadResultsTable();
            } catch (error) {
                console.error('Load results error:', error);
                loadResultsTable(); // Use local data
            }
        }

        function showAdminSection(section) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            // Update navigation buttons
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'text-blue-700', 'font-medium');
                btn.classList.add('hover:bg-gray-50', 'text-gray-700');
            });
            
            // Show selected section
            document.getElementById(`admin${section.charAt(0).toUpperCase() + section.slice(1)}Section`).classList.remove('hidden');
            
            // Update active navigation button
            event.target.classList.remove('hover:bg-gray-50', 'text-gray-700');
            event.target.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
        }

        function updateAdminStats() {
            document.getElementById('totalStudents').textContent = adminData.students.length;
            document.getElementById('totalExams').textContent = adminData.exams.length;
            
            // Calculate average score
            if (adminData.results.length > 0) {
                const avgScore = adminData.results.reduce((sum, result) => sum + result.score, 0) / adminData.results.length;
                document.getElementById('averageScore').textContent = Math.round(avgScore);
            }
        }

        // Student Management
        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('hidden');
        }

        function hideAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('addStudentModal').querySelector('form').reset();
        }

        async function addStudent(event) {
            event.preventDefault();
            
            const nisn = document.getElementById('newStudentNISN').value;
            const name = document.getElementById('newStudentName').value;
            const studentClass = document.getElementById('newStudentClass').value;
            const password = document.getElementById('newStudentPassword').value;
            
            try {
                // Check if NISN already exists in database
                const { data: existingStudent, error: checkError } = await supabase
                    .from('students')
                    .select('nisn')
                    .eq('nisn', nisn)
                    .single();
                    
                if (existingStudent) {
                    alert('NISN sudah terdaftar!');
                    return;
                }
                
                // Insert new student
                const { data, error } = await supabase
                    .from('students')
                    .insert([{
                        nisn: nisn,
                        name: name,
                        class: studentClass,
                        password: password,
                        status: 'Aktif'
                    }]);
                    
                if (error) throw error;
                
                // Refresh students table
                await loadStudentsFromDatabase();
                updateAdminStats();
                hideAddStudentModal();
                showNotification('‚úÖ Siswa berhasil ditambahkan!', 'success');
                
            } catch (error) {
                console.error('Add student error:', error);
                
                // Fallback to local storage
                if (adminData.students.find(student => student.nisn === nisn)) {
                    alert('NISN sudah terdaftar!');
                    return;
                }
                
                adminData.students.push({
                    nisn: nisn,
                    name: name,
                    class: studentClass,
                    password: password,
                    status: 'Aktif'
                });
                
                loadStudentsTable();
                updateAdminStats();
                hideAddStudentModal();
                alert('Siswa berhasil ditambahkan!');
            }
        }

        function loadStudentsTable() {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';
            
            adminData.students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nisn}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${student.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${student.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editStudent('${student.nisn}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteStudent('${student.nisn}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteStudent(nisn) {
            if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
                adminData.students = adminData.students.filter(student => student.nisn !== nisn);
                loadStudentsTable();
                updateAdminStats();
                alert('Siswa berhasil dihapus!');
            }
        }

        // Question Management
        function showAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.remove('hidden');
        }

        function hideAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.add('hidden');
            document.getElementById('addQuestionModal').querySelector('form').reset();
        }

        function addQuestion(event) {
            event.preventDefault();
            
            const questionText = document.getElementById('newQuestionText').value;
            const questionType = document.getElementById('newQuestionType').value;
            const optionA = document.getElementById('newQuestionOptionA').value;
            const optionB = document.getElementById('newQuestionOptionB').value;
            const optionC = document.getElementById('newQuestionOptionC').value;
            const optionD = document.getElementById('newQuestionOptionD').value;
            const correct = parseInt(document.getElementById('newQuestionCorrect').value);
            
            const newQuestion = {
                id: originalQuestions.length + 1,
                question: questionText,
                options: [optionA, optionB, optionC, optionD],
                type: questionType,
                hasImage: false
            };
            
            originalQuestions.push(newQuestion);
            correctAnswers[newQuestion.id] = correct;
            
            // Regenerate randomized questions
            questions = randomizeQuestions(originalQuestions);
            totalQuestions = questions.length;
            
            loadQuestionsTable();
            updateAdminStats();
            hideAddQuestionModal();
            alert('Soal berhasil ditambahkan!');
        }

        function loadQuestionsTable() {
            const tbody = document.getElementById('questionsTable');
            tbody.innerHTML = '';
            
            originalQuestions.forEach((question, index) => {
                const row = document.createElement('tr');
                const correctOption = String.fromCharCode(65 + correctAnswers[question.id]);
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${question.id}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${question.question}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${question.type === 'multiple_choice' ? 'Pilihan Ganda' : 'Pilihan Ganda + Gambar'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${correctOption}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editQuestion(${question.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteQuestion(${question.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteQuestion(id) {
            if (confirm('Apakah Anda yakin ingin menghapus soal ini?')) {
                const index = originalQuestions.findIndex(q => q.id === id);
                if (index > -1) {
                    originalQuestions.splice(index, 1);
                    delete correctAnswers[id];
                    
                    // Regenerate randomized questions
                    questions = randomizeQuestions(originalQuestions);
                    totalQuestions = questions.length;
                    
                    loadQuestionsTable();
                    updateAdminStats();
                    alert('Soal berhasil dihapus!');
                }
            }
        }

        // Exam Management
        function showCreateExamModal() {
            document.getElementById('createExamModal').classList.remove('hidden');
        }

        function hideCreateExamModal() {
            document.getElementById('createExamModal').classList.add('hidden');
            document.getElementById('createExamModal').querySelector('form').reset();
        }

        function createExam(event) {
            event.preventDefault();
            
            const name = document.getElementById('newExamName').value;
            const subject = document.getElementById('newExamSubject').value;
            const duration = parseInt(document.getElementById('newExamDuration').value);
            const questionCount = parseInt(document.getElementById('newExamQuestions').value);
            
            const newExam = {
                id: adminData.exams.length + 1,
                name: name,
                subject: subject,
                duration: duration,
                questions: questionCount,
                status: 'Aktif'
            };
            
            adminData.exams.push(newExam);
            
            loadExamsTable();
            updateAdminStats();
            hideCreateExamModal();
            alert('Ujian berhasil dibuat!');
        }

        function loadExamsTable() {
            const tbody = document.getElementById('examsTable');
            tbody.innerHTML = '';
            
            adminData.exams.forEach(exam => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${exam.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${exam.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${exam.duration} menit</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${exam.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${exam.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editExam(${exam.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteExam(${exam.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteExam(id) {
            if (confirm('Apakah Anda yakin ingin menghapus ujian ini?')) {
                adminData.exams = adminData.exams.filter(exam => exam.id !== id);
                loadExamsTable();
                updateAdminStats();
                alert('Ujian berhasil dihapus!');
            }
        }

        // Results Management
        function loadResultsTable() {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';
            
            adminData.results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.nisn}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.exam}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.score}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getGradeColor(result.grade)}">
                            ${result.grade}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.time}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewResultDetail('${result.nisn}')" class="text-blue-600 hover:text-blue-900 mr-3">Detail</button>
                        <button onclick="deleteResult('${result.nisn}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getGradeColor(grade) {
            switch(grade) {
                case 'A': return 'bg-green-100 text-green-800';
                case 'B': return 'bg-blue-100 text-blue-800';
                case 'C': return 'bg-yellow-100 text-yellow-800';
                case 'D': return 'bg-orange-100 text-orange-800';
                case 'E': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function deleteResult(nisn) {
            if (confirm('Apakah Anda yakin ingin menghapus hasil ujian ini?')) {
                adminData.results = adminData.results.filter(result => result.nisn !== nisn);
                loadResultsTable();
                updateAdminStats();
                alert('Hasil ujian berhasil dihapus!');
            }
        }

        // Update showScreen function for smart login system
        function showScreen(screenId) {
            const screens = ['loginScreen', 'cbtInterface', 'adminDashboard', 'resultScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            showScreen('loginScreen');
            
            // Initialize database
            await initializeDatabase();
            
            // Show connection status
            try {
                const { data, error } = await supabase.from('students').select('count').limit(1);
                if (!error) {
                    console.log('‚úÖ Supabase connected successfully');
                    showNotification('üîó Database terhubung!', 'success');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Using offline mode');
                showNotification('üì± Mode offline aktif', 'info');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e5a88db03cf9e6',t:'MTc1Nzc0NTY4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
